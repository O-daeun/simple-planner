// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
* Auth.js (NextAuth) 기본 테이블 (Prisma Adapter 정석 형태)
* - DB Session 전략 + 다중 OAuth 확장 대비
*/

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?

  // relations (Auth.js)
  accounts Account[]
  sessions Session[]

  // app relations
  timeBlocks      TimeBlock[]
  timeRecurrences TimeBlockRecurrence[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                String @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String

  refresh_token String?
  access_token  String?
  expires_at    Int?
  token_type    String?
  scope         String?
  id_token      String?
  session_state String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

/**
* Planner - TimeBox (하루 단위 타임블록)
* - date는 DATE로 저장 (시간대 이슈 방지)
* - startMin/endMin은 "00:00 기준 분" 정수
*/

model TimeBlock {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 날짜만 저장 (Postgres DATE)
  date DateTime @db.Date

  startMin Int
  endMin   Int

  title String
  color String? // "#RRGGBB"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, date])
  @@index([userId, date, startMin])
}

/**
* 반복 규칙
* - daysOfWeek: Int[]  (0=일, 1=월 ... 6=토)
* - startDate/untilDate도 DATE로 저장
*/

model TimeBlockRecurrence {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  startMin Int
  endMin   Int

  // 예: 월/수/금 => [1,3,5]
  daysOfWeek Int[]

  startDate DateTime  @db.Date
  untilDate DateTime? @db.Date

  title String
  color String?

  exceptions TimeBlockRecurrenceException[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, startDate])
}

enum RecurrenceExceptionType {
  SKIP
  MODIFY
}

model TimeBlockRecurrenceException {
  id String @id @default(cuid())

  recurrenceId String
  recurrence   TimeBlockRecurrence @relation(fields: [recurrenceId], references: [id], onDelete: Cascade)

  // 예외가 적용되는 날짜 (DATE)
  date DateTime @db.Date

  type RecurrenceExceptionType

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([recurrenceId, date])
  @@index([recurrenceId])
}
